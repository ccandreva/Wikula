WikkaEdit.prototype.init=function(){this.we_actionsMenuEnabled=(typeof(this.contextualHelp)!="undefined");this.we_searchReplaceEnabled=(typeof(this.showSearchWindow)!="undefined");this.initButtons();if(this.we_actionsMenuEnabled){this.initCategs();this.initActions()}var a=document.getElementById("textarea_container");this.we_toolbar=document.createElement("div");this.we_toolbar.id="wikkatoolbar";this.we_toolbar.innerHTML=this.genToolbar();a.parentNode.insertBefore(this.we_toolbar,a);this.we_submenu=document.createElement("div");this.we_submenu.id="wikkasubmenu";this.we_submenu.style.visibility="hidden";a.parentNode.insertBefore(this.we_submenu,a);if(this.we_searchReplaceEnabled){this.we_search=document.createElement("div");this.we_search.id="wikkasearch";this.we_search.style.visibility="hidden";this.we_search.style.width="500px";this.we_search.style.height="180px";a.parentNode.insertBefore(this.we_search,a.nextSibling);this.we_searchTa=document.createElement("textarea");this.we_searchTa.style.position="absolute";this.we_searchTa.style.left=0;this.we_searchTa.style.top=0;this.we_searchTa.style.visibility="hidden";this.we_searchTa.style.scroll="auto";a.parentNode.insertBefore(this.we_searchTa,a.nextSibling)}if(this.we_actionsMenuEnabled){this.we_helpPreviousContent="&nbsp;";this.we_help=document.createElement("div");this.we_help.id="wikkahelp";this.we_help.innerHTML=this.we_helpPreviousContent;this.we_help.style.display=(this.we_actionsMenuEnabled?"":"none");a.parentNode.insertBefore(this.we_help,a.nextSibling.nextSibling);this.we_tooltip=document.createElement("div");this.we_tooltip.id="wikkatooltip";this.we_tooltip.style.visibility="hidden";a.parentNode.insertBefore(this.we_tooltip,this.we_help.nextSibling)}this.we_log=document.createElement("div");this.we_log.id="wikkalog";this.we_log.innerHTML="log<br/>";this.we_log.style.display="none";a.parentNode.insertBefore(this.we_log,a.nextSibling);this.setSelectionRange(0,0);this.we_ta.onkeydown=this.keyDown;this.we_ta.onmousedown=this.mouseDown;this.we_ta.focus();setInterval("varWikkaEdit.moveElementsAfterWindowResize();",this.EDITOR_HEIGHT_POLL_INTERV);if(this.we_actionsMenuEnabled){setInterval("varWikkaEdit.contextualHelp();",this.CONTEXTUAL_HELP_POLL_INTERV)}};WikkaEdit.prototype.browserSupported=function(){var b=false;try{var d=(this.we_ta.selectionStart!=null);var a=(document.selection&&document.selection.createRange);if(d||a){b=true}}catch(c){}return b};WikkaEdit.prototype.moveElementsAfterWindowResize=function(){try{if(this.we_ta.style.height==""){this.we_ta.style.height="500px"}var f=parseInt(window.innerHeight?window.innerHeight:document.documentElement.clientHeight,10);var d=f-parseInt(document.body.offsetHeight,10)-20;if(d!=0){var a=Math.max(this.EDITOR_MIN_HEIGHT,parseInt(this.we_ta.style.height,10)+d);this.we_ta.style.height=a+"px"}if(this.we_searchReplaceEnabled){var b=parseInt(window.innerWidth?window.innerWidth:document.documentElement.clientWidth,10);this.we_search.style.left=(b/2-parseInt(this.we_search.style.width,10)/2)+"px";this.we_search.style.top=(f-parseInt(this.we_search.style.height,10)-1)+"px"}}catch(c){}};WikkaEdit.prototype.genToolbar=function(){var c=(navigator.userAgent.indexOf("MSIE 6.0")==-1?"":" onmouseover=\"this.className='toolbutton_hover';\" onmouseout=\"this.className='toolbutton_std';\"");var b="";for(var a in this.we_buttons){switch(this.we_buttons[a].type){case"button":b+='<img class="toolbutton" src="'+Zikula.Config.baseURL+"modules/Wikka/editor/wikkaedit132/images/"+this.refToName(a)+'.gif" alt="'+this.refToName(a)+'" title="'+this.we_buttons[a].title+'" onclick="varWikkaEdit.toolbarButtonClick(this, \''+this.refToName(a)+"');\""+c+" />";break;case"submenu":b+='<img class="toolbutton" src="'+Zikula.Config.baseURL+'modules/Wikka/editor/wikkaedit132/images/submenu.gif" alt="submenu" title="'+this.we_buttons[a].title+'" onclick="varWikkaEdit.toolbarButtonClick(this, \''+this.refToName(a)+"');\""+c+" />";break;case"separator":b+='<img class="toolseparator" src="'+Zikula.Config.baseURL+'modules/Wikka/editor/wikkaedit132/images/separator.gif" alt="|" />';break;default:alert("genToolbar() : unknown type ("+this.we_buttons[a].type+")")}}if(this.we_actionsMenuEnabled){b+="<div class='toolhorizsep'></div>";b+="<span class='actiontitle'>Actions</span>";for(a in this.we_categs){if(this.we_categs[a].title!=null){b+="<span class=\"toolbutton\" style='margin-left:20px; padding:2px 5px 3px 6px' onclick=\"varWikkaEdit.toolbarCategClick('"+a+"', this);\">"+this.we_categs[a].title+"<img src='"+Zikula.Config.baseURL+"modules/Wikka/editor/wikkaedit132/images/submenu.gif' style='vertical-align:middle'/></span>"}}}return b};WikkaEdit.prototype.toolbarButtonClick=function(e,a,d){if(((d!=null)||(this.we_buttons[this.nameToRef(a)].type!="submenu"))&&(a!="shortcuts")){this.hideSubmenu()}switch(a){case"h1":this.addToLine("======","======");break;case"h2":this.addToLine("=====","=====");break;case"h3":this.addToLine("====","====");break;case"h4":this.addToLine("===","===");break;case"h5":this.addToLine("==","==");break;case"bold":this.addToSelection("**","**");break;case"italic":this.addToSelection("//","//");break;case"underline":this.addToSelection("__","__");break;case"strike":this.addToSelection("++","++");break;case"style":this.toggleSubmenu(e,"style");break;case"justifycenter":this.addToLine("@@","@@");break;case"bullist":this.addToLine("\t- ");break;case"numlist":this.addToLine("\t1) ");break;case"comments":this.addToLine("\t& ");break;case"indent":this.indent(1);break;case"outdent":this.indent(-1);break;case"hr":this.addToSelection("----");break;case"link":this.addToSelection("[[http://www.example.com Page Title]]");break;case"image":this.toolbarActionClick("we_image");break;case"table":this.addToSelection("|=|header1|=|header2||\n||cell1||cell2||");break;case"rawhtml":var b=this.getSelectionRange();if(event.shiftKey){b=this.getSelectionRangeWholeLines()}if(b.end-b.start>0){this.addToSelection('""','""',null,b)}else{var c=new SelRange(b.start+2,b.start+22);this.addToSelection('""insert-raw-html-here""',"",c,b)}break;case"sourcecode":var b=this.getSelectionRange();if(event.shiftKey){b=this.getSelectionRangeWholeLines()}var c=new SelRange(b.start+3,b.start+15);if(b.end-b.start>0){this.addToSelection("%%(language-ref)\n","\n%%",c,b)}else{this.addToSelection("%%(language-ref)\ninsert-source-code-here\n%%","",c,b)}break;case"find":this.showSearchWindow();break;case"shortcuts":this.toggleSubmenu(e,"shortcuts");break;case"formatting_rules":this.showFormattingRules();break;case"forecolor":this.toolbarActionClick("we_color");break;case"monospace":this.addToSelection("##","##");break;case"highlight":this.addToSelection("''","''");break;case"key":this.addToSelection("#%","#%");break;case"leftfloat":this.addToLine("<<","<<");break;case"rightfloat":this.addToLine(">>",">>");break;default:alert("toolbarButtonClick() : unknown buttonName ("+a+")")}};WikkaEdit.prototype.showFormattingRules=function(){var a=window.location.href;a=a.replace(/[a-zA-Z0-9]+\/edit.*$/,"FormattingRules");window.open(a,"wikka_formatting_rules")};WikkaEdit.prototype.toolbarCategClick=function(a,b){this.toggleSubmenu(b,a,true)};WikkaEdit.prototype.toolbarActionClick=function(e){this.hideSubmenu();var d="";if(this.we_actionsMenuEnabled){var b=this.we_actions[e].we_name;var a;d+="{{"+b;for(var c in this.we_actions[e].we_params){a=this.we_actions[e].we_params[c];if((a.nodefault==null)||(a.nodefault==false)){d+=" "+a.name+'="'+a.value+'"'}}d+="}}"}else{switch(e){case"we_image":d='{{image url="url" title="text" alt="text"}}';break;case"we_color":d='{{color text="text" c="color"}}';break;default:alert("toolbarActionClick() : actionRef="+e)}}this.addToSelection(d)};WikkaEdit.prototype.hideSubmenu=function(){this.we_submenu.style.visibility="hidden"};WikkaEdit.prototype.toggleSubmenu=function(g,a,d){d=(d==true);if((a==this.we_currentSubmenu)&&(this.we_submenu.style.visibility!="hidden")){this.hideSubmenu();this.we_ta.focus();return}var e=this.getObjectCoords(g);e.y+=25;this.we_submenu.style.left=e.x+"px";this.we_submenu.style.top=e.y+"px";var c="";if(a=="shortcuts"){var f=350;c+="<div style='width:"+f+"px' onclick='varWikkaEdit.hideSubmenu();'>";c+="<div id='sr_window_title'>Editor shortcuts</div>";c+="<div style='padding:5px 5px 10px 10px; line-height:200%'>";c+="<span class='we_key'>Ctrl</span> + <span class='we_key'>B</span> : bold<br/>";c+="<span class='we_key'>Ctrl</span> + <span class='we_key'>I</span> : italic<br/>";c+="<span class='we_key'>Ctrl</span> + <span class='we_key'>U</span> : underline<br/>";c+="<span class='we_key'>Ctrl</span> + <span class='we_key'>Shift</span> + <span class='we_key'>S</span> : strike<br/>";c+="<br/>";c+="<span class='we_key'>Tab</span> : tab character or indent<br/>";c+="<span class='we_key'>Shift</span> + <span class='we_key'>Tab</span> : outdent<br/>";c+="<br/>";if(!this.we_webkit){c+="<span class='we_key'>Ctrl</span> + <span class='we_key'>F</span> : search &amp; replace<br/>";c+="<br/>"}c+="<span class='we_key'>Esc</span> : release focus<br/>";c+="</div>";c+="</div>";this.we_submenu.style.left=(e.x-f+18)+"px"}else{var h=(navigator.userAgent.indexOf("MSIE 6.0")==-1?"":" onmouseover=\"this.className='toolbutton_hover';\" onmouseout=\"this.className='toolbutton_std';\"");var b;if(!d){for(b in this.we_buttons[this.nameToRef(a)].we_buttons){c+='<div class="smbutton" onclick="varWikkaEdit.toolbarButtonClick(this, \''+this.refToName(b)+"', '"+a+"');\">";c+='<img class="smimage" src="'+Zikula.Config.baseURL+"modules/Wikka/editor/wikkaedit132/images/"+this.refToName(b)+'.gif" alt="'+this.refToName(b)+'"'+h+" />";c+=this.we_buttons[this.nameToRef(a)].we_buttons[b].title;c+="</div>"}}else{for(b in this.we_actions){if(this.we_actions[b].categ==a){c+='<div class="smbutton" onclick="varWikkaEdit.toolbarActionClick(\''+b+"');\""+(this.we_actions[b].summary==null?"":' title="'+this.we_actions[b].summary+'"')+">";c+='<img class="smimage" src="'+Zikula.Config.baseURL+"modules/Wikka/editor/wikkaedit132/images/"+this.we_actions[b].name+'.gif" alt="'+this.we_actions[b].name+'"'+h+" />";c+=this.we_actions[b].we_title;c+="</div>"}}}}this.we_submenu.innerHTML=c;this.we_submenu.style.visibility="";this.we_currentSubmenu=a};WikkaEdit.prototype.mouseDown=function(a){varWikkaEdit.hideSubmenu()};WikkaEdit.prototype.keyDown=function(d){if(!varWikkaEdit.we_canCancelKeyEvent){return true}if(d==null){d=window.event}var b=(d.keyCode!=null?d.keyCode:d.which);switch(b){case 9:if(d.shiftKey){varWikkaEdit.indent(-1)}else{var c=varWikkaEdit.getSelectionRange();if(c.start==c.end){var f=new SelRange(c.end+1);varWikkaEdit.addToSelection("\t",null,f)}else{varWikkaEdit.indent(1)}}return varWikkaEdit.cancelKey(d);case 13:var a=varWikkaEdit.autoIndent();if(a){return true}else{return varWikkaEdit.cancelKey(d)}case 27:varWikkaEdit.we_ta.blur();return varWikkaEdit.cancelKey(d)}if(d.ctrlKey){switch(b){case 66:varWikkaEdit.toolbarButtonClick(null,"bold");return varWikkaEdit.cancelKey(d);case 73:varWikkaEdit.toolbarButtonClick(null,"italic");return varWikkaEdit.cancelKey(d);case 85:varWikkaEdit.toolbarButtonClick(null,"underline");return varWikkaEdit.cancelKey(d);case 83:if(d.shiftKey){varWikkaEdit.toolbarButtonClick(null,"strike");return varWikkaEdit.cancelKey(d)}break;case 70:if(varWikkaEdit.we_searchReplaceEnabled){varWikkaEdit.showSearchWindow();return varWikkaEdit.cancelKey(d)}break}}return true};WikkaEdit.prototype.cancelKey=function(a){return false};WikkaEdit.prototype.autoIndent=function(){var a=this.getSelectionRange();var d=this.getSelectionContent(a);var c="(    +|\t+|~+)";var f="(-|&|([1-9][0-9]*|[a-zA-Z])([.]|[)])|)";var k=new RegExp("^"+c+f+"(.*)$");var e=d.previousLine.match(k);if(e){var h=e[1];var g=e[2];var j=e[5].replace(/\s+/g,"");var i=d.before+"\n"+h+g+(g==""?"":" ");var b=new SelRange(i.length);this.setTextAreaContent(i+d.after,b);return false}return true};WikkaEdit.prototype.addToSelection=function(c,d,g,f){if(timeoutSelectionRange!=null){this.addLog("addToSelection() was called, but setSelectionRange() setTimeout() is not finished")}if(d==null){d=""}var b=(f!=null?f:this.getSelectionRange());var a=this.getSelectionContent(b);if(c=="----"){if((a.before!="")&&(a.before.substr(a.before.length-1)!="\n")){c="\n"+c}if((a.after!="")&&(a.after.substr(0,1)!="\n")){c+="\n"}}var e;if(g!=null){e=g}else{e=new SelRange(b.start+c.length,b.end+c.length)}this.setTextAreaContent(a.before+c+a.sel+d+a.after,e)};WikkaEdit.prototype.addToLine=function(f,g){if(timeoutSelectionRange!=null){this.addLog("addToLine() was called, but setSelectionRange() setTimeout() is not finished")}if(g==null){g=""}var e=this.getSelectionRangeWholeLines();var c=this.getSelectionContent(e);e=this.getSelectionRange();var a=c.sel.split("\n");var b="";for(var d=0;d<a.length;d++){b+=f+a[d]+g+(d<a.length-1?"\n":"");if(d==0){e.start+=f.length}e.end+=f.length}this.setTextAreaContent(c.before+b+c.after,e)};WikkaEdit.prototype.indent=function(e){if(timeoutSelectionRange!=null){this.addLog("addToLine() was called, but setSelectionRange() setTimeout() is not finished")}var f=this.getSelectionRangeWholeLines();var c=this.getSelectionContent(f);f=this.getSelectionRange();var a=c.sel.split("\n");var b="";for(var d=0;d<a.length;d++){if(e==-1){if(a[d].substr(0,1)=="\t"){b+=a[d].substr(1)+(d<a.length-1?"\n":"");if(d==0){f.start--}f.end--}else{b+=a[d]+(d<a.length-1?"\n":"")}}else{b+="\t"+a[d]+(d<a.length-1?"\n":"");if(d==0){f.start+=1}f.end+=1}}this.setTextAreaContent(c.before+b+c.after,f)};var timeoutSelectionRange=null;WikkaEdit.prototype.setSelectionRange=function(b,a){if(timeoutSelectionRange!=null){this.addLog("setSelectionRange() was called too early => exit");return}if(navigator.userAgent.indexOf("KHTML")==-1&&navigator.userAgent.indexOf("Mozilla")==-1){this.setSelectionRange2(b,a)}else{timeoutSelectionRange=setTimeout("varWikkaEdit.setSelectionRange2("+b+", "+a+");",1)}};WikkaEdit.prototype.setSelectionRange2=function(h,a){if(typeof(this.we_ta.setSelectionRange)!="undefined"){if(this.we_ta.value.indexOf("\r\n")!=-1){var g=this.getTextAreaContent();var f;f=g.substr(0,h);f=f.replace(/\n/g,"  ");var d=f.length-h;f=g.substr(0,a);f=f.replace(/\n/g,"  ");var c=f.length-a;h+=d;a+=c}if(window.opera==null){this.we_ta.setSelectionRange(h,a)}else{if(h!=a){this.we_ta.setSelectionRange(h,a)}else{var e=this.getSelectionRange();if((e.start!=h)||(e.end!=a)){this.we_ta.setSelectionRange(h,a)}if((e.start!=h)||(e.end!=a)){this.we_ta.setSelectionRange(h,h+1)}}}}else{var b=this.we_ta.createTextRange();b.collapse(true);b.moveStart("character",h);b.moveEnd("character",a-h);b.select()}timeoutSelectionRange=null};WikkaEdit.prototype.getSelectionContent=function(b){var c=this.getTextAreaContent();var a=new Object();a.before=c.substr(0,b.start);a.after=c.substr(b.end);a.sel=c.substring(b.start,b.end);a.previousLine=a.before.substr(a.before.lastIndexOf("\n")+1);return a};WikkaEdit.prototype.getSelectionRange=function(){var b=0;var f=0;if(typeof(this.we_ta.setSelectionRange)!="undefined"){b=this.we_ta.selectionStart;f=this.we_ta.selectionEnd;if(this.we_ta.value.indexOf("\r\n")!=-1){var l=this.getTextAreaContent();var k;k=l.substr(0,b);k=k.replace(/\n/g,"  ");var e=k.length-b;k=l.substr(0,f);k=k.replace(/\n/g,"  ");var j=k.length-f;b-=e;f-=j}}else{this.we_ta.focus();var d=document.selection.createRange();var c=d.duplicate();c.moveToElementText(this.we_ta);var g="<WikkaRangeMark>";var a=d.text;d.text=g;var i=c.text.indexOf(g);b=this.js_countTextAreaChars(i==-1?c.text:c.text.substring(0,i));f=this.js_countTextAreaChars(a)+b;d.moveStart("character",-g.length);d.text=a;var h=this.we_ta.createTextRange();h.collapse(true);h.moveStart("character",b);h.moveEnd("character",f-b);h.select()}return new SelRange(b,f)};WikkaEdit.prototype.getSelectionRangeWholeLines=function(){var b=this.getSelectionRange();var d=this.getTextAreaContent();var a=d.lastIndexOf("\n",b.start-1);if(a>0){a++}else{a=0}var c=d.indexOf("\n",b.end);if(c==-1){c=d.length}b.start=a;b.end=c;return b};WikkaEdit.prototype.js_countTextAreaChars=function(a){a=a.replace(/\r\n/g,"\n");a=a.replace(/\r/g,"\n");return a.length};WikkaEdit.prototype.getTextAreaContent=function(){var a=this.we_ta.value;a=a.replace(/\r\n/g,"\n");a=a.replace(/\r/g,"\n");return a};WikkaEdit.prototype.setTextAreaContent=function(c,a){var b=this.we_ta.scrollTop;this.we_ta.value=c;this.we_ta.scrollTop=b;this.we_ta.focus();this.setSelectionRange(a.start,a.end)};WikkaEdit.prototype.addLog=function(a){this.we_log.style.display="";this.we_log.innerHTML=a+"<br/>"+this.we_log.innerHTML};WikkaEdit.prototype.clearLog=function(){if(this.we_log.style.display==""){this.we_log.innerHTML=""}};WikkaEdit.prototype.trim=function(a){while(a.charAt(0)==" "){a=a.substr(1)}while(a.charAt(a.length-1)==" "){a=a.substr(0,a.length-1)}return a};WikkaEdit.prototype.getObjectCoords=function(b){var a=0,c=0;do{a+=b.offsetLeft;c+=b.offsetTop}while((b=b.offsetParent)!=null);return{x:a,y:c}};function SelRange(b,a){this.start=b;this.end=(a==null?b:a)}var varWikkaEdit=new WikkaEdit(document.getElementById("body"));if(varWikkaEdit.browserSupported()){varWikkaEdit.init()};